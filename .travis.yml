language: node_js
node_js:
- '8'

cache:
  directories:
  - node_modules

install:
- npm install

script:
- npm run lint:nofix
- npm run test:unit
- npm run build

before_deploy:
- zip alerta-web-beta.zip -r dist/*
- tar cvfz alerta-web-beta.tar.gz dist/*

jobs:
  include:
  - stage: deploy
    before_script: echo VUE_APP_ALERTA_ENDPOINT=https://alerta-api.herokuapp.com > .env
    script: npm run build
    deploy:
    - provider: pages
      skip-cleanup: true
      github-token: "$GITHUB_TOKEN"
      target-branch: gh-pages
      local-dir: dist
      on:
        branch: master
  - stage: release
    deploy:
    - provider: releases
      skip-cleanup: true
      api_key: "$GITHUB_TOKEN"
      file:
        - alerta-web-beta.zip
        - alerta-web-beta.tar.gz
      on:
        tags: true
